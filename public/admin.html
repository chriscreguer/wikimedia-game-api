<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Year Guessing Game - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #0F0422;
      color: #fff;
    }
    .card {
      background-color: #150A29;
      border: 1px solid #322A3F;
    }
    .card-header, .input-group-text {
      background-color: #1D1033;
      color: #fff;
      border-color: #322A3F;
    }
    .form-control, .form-select {
      background-color: #0F061F;
      border-color: #322A3F;
      color: #fff;
    }
    .form-control:focus, .form-select:focus {
      background-color: #0F061F;
      color: #fff;
      border-color: #6C2DC7;
      box-shadow: 0 0 0 0.25rem rgba(108, 45, 199, 0.25);
    }
    .btn-primary {
      background-color: #6C2DC7;
      border-color: #6C2DC7;
    }
    .btn-primary:hover {
      background-color: #5923A6;
      border-color: #5923A6;
    }
    .btn-danger {
      background-color: #DC3545;
      border-color: #DC3545;
    }
    .btn-success {
      background-color: #198754;
      border-color: #198754;
    }
    .btn-outline-secondary {
      color: #fff;
      border-color: #322A3F;
    }
    .btn-outline-secondary:hover {
      background-color: #322A3F;
      color: #fff;
    }
    .challenge-card {
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .challenge-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    .challenge-image {
      height: 150px;
      width: 100%;
      object-fit: cover;
      border-radius: 4px 4px 0 0;
    }
    .form-text {
      color: #B39DDB;
    }
    .table {
      color: #fff;
    }
    .table thead {
      background-color: #1D1033;
    }
    .text-muted {
      color: #B39DDB !important;
    }
    #adminKeyModal .modal-content, #editChallengeModal .modal-content {
      background-color: #150A29;
      border: 1px solid #322A3F;
      color: #fff;
    }
    /* Calendar specific styles */
    #calendarContainer table {
      margin-bottom: 0;
    }
    #calendarContainer td {
      vertical-align: middle;
      height: 40px;
    }
    .timezone-indicator {
      font-size: 0.8rem;
      color: #B39DDB;
    }
    .modal-lg {
      max-width: 800px;
    }
    .image-item {
      position: relative;
      margin-bottom: 15px;
    }
    .image-controls {
      position: absolute;
      top: 5px;
      right: 5px;
    }
    .badge-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(0,0,0,0.7);
      padding: 2px 8px;
      border-radius: 10px;
    }
  </style>
</head>
<body class="text-white">
  <div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Year Guessing Game - Admin Dashboard</h1>
      <div>
        <span class="timezone-indicator me-3">All times in Eastern Time (ET)</span>
        <button class="btn btn-outline-secondary" id="setKeyBtn">Set Admin Key</button>
      </div>
    </div>

    <!-- Create Challenge Card -->
    <div class="card challenge-card mb-4">
      <div class="card-header">
        <h3>Create Daily Challenge</h3>
      </div>
      <div class="card-body">
        <form id="createForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="date" class="form-label">Challenge Date (ET)</label>
              <input type="datetime-local" class="form-control" id="date" required />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Wikimedia Images</label>
            <p class="form-text mb-2">Add up to 10 Wikimedia URLs (one per line or separated by commas)</p>
            <textarea class="form-control" id="imageUrls" rows="5" placeholder="https://upload.wikimedia.org/wikipedia/commons/0/06/50_Ans_de_l%27INRA_Portes_ouvertes_%C3%A0_Versailles-221-cliche_Jean_Weber.jpg" required></textarea>
            <div class="form-text">Currently added: <span id="urlCount">0</span>/10 images</div>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="appendImages" />
            <label class="form-check-label" for="appendImages">
              Append to existing images (if date already has a challenge)
            </label>
          </div>

          <div class="mb-3">
            <div id="previewContainer" class="mt-3">
              <h5>Image Previews</h5>
              <div id="previewGrid" class="row"></div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">Create Challenge</button>
        </form>
      </div>
    </div>

    <!-- Calendar Card -->
    <div class="card challenge-card mb-4">
      <div class="card-header">
        <h3>Calendar</h3>
      </div>
      <div class="card-body">
        <div id="calendarContainer"></div>
      </div>
    </div>

    <!-- Existing Challenges Card -->
    <div class="card challenge-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3>Existing Challenges</h3>
        <button id="refreshBtn" class="btn btn-outline-secondary">Refresh</button>
      </div>
      <div class="card-body">
        <div id="challengesList" class="row"></div>
      </div>
    </div>
  </div>

  <!-- Admin Key Modal -->
  <div class="modal fade" id="adminKeyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Set Admin Key</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="adminKey" class="form-label">Admin API Key</label>
            <input type="password" class="form-control" id="adminKey" placeholder="Enter your admin API key" />
            <div class="form-text">This should match the ADMIN_API_KEY in your server's environment variables.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveKeyBtn">Save Key</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Challenge Modal -->
  <div class="modal fade" id="editChallengeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Challenge</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editChallengeForm">
            <input type="hidden" id="editChallengeId">
            <div class="mb-3">
              <label for="editChallengeDate" class="form-label">Challenge Date (ET)</label>
              <input type="datetime-local" class="form-control" id="editChallengeDate" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Challenge Images</label>
              <div id="editImagesContainer" class="row"></div>
            </div>

            <div class="mb-3">
              <label class="form-label">Add New Images</label>
              <textarea class="form-control" id="editNewImages" rows="3" placeholder="Add new Wikimedia URLs (one per line or separated by commas)"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global variables
    let adminKey = localStorage.getItem('adminKey') || '';
    let allChallenges = [];
    let currentDisplayDate = new Date(); // Used for calendar display
    let currentEditingChallenge = null;

    // Modal control
    const adminKeyModal = new bootstrap.Modal(document.getElementById('adminKeyModal'));
    const editChallengeModal = new bootstrap.Modal(document.getElementById('editChallengeModal'));
    
    document.getElementById('setKeyBtn').addEventListener('click', () => {
      document.getElementById('adminKey').value = adminKey;
      adminKeyModal.show();
    });
    
    document.getElementById('saveKeyBtn').addEventListener('click', () => {
      const newKey = document.getElementById('adminKey').value.trim();
      if (newKey) {
        adminKey = newKey;
        localStorage.setItem('adminKey', adminKey);
        adminKeyModal.hide();
        loadChallenges();
      }
    });

    // Convert UTC to ET
    function convertToET(utcDate) {
      const date = new Date(utcDate);
      return new Date(date.toLocaleString('en-US', {timeZone: 'America/New_York'}));
    }

    // Convert ET to UTC
    function convertToUTC(etDateStr) {
      const etDate = new Date(etDateStr);
      const utcDate = new Date(etDate.getTime() + etDate.getTimezoneOffset() * 60000);
      return utcDate;
    }

    // Format date for datetime-local input
    function formatDateForInput(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Extract filename from URL
    function extractFilenameFromUrl(url) {
      try {
        const urlObj = new URL(url);
        const segments = urlObj.pathname.split('/');
        return decodeURIComponent(segments[segments.length - 1]);
      } catch (error) {
        console.error('Invalid URL:', error);
        return null;
      }
    }

    // Parse and validate URLs
    function parseImageUrls(text) {
      let urls = text.split(/\n/).map(line => line.trim()).filter(line => line);
      if (urls.length === 1) {
        urls = urls[0].split(',').map(url => url.trim()).filter(url => url);
      }
      return urls.filter(url => url.includes('wikimedia.org'));
    }

    // Image preview handler
    document.getElementById('imageUrls').addEventListener('input', function() {
      const text = this.value.trim();
      const previewGrid = document.getElementById('previewGrid');
      const urlCount = document.getElementById('urlCount');
      const urls = parseImageUrls(text);
      urlCount.textContent = urls.length;
      if (urls.length > 10) {
        this.value = urls.slice(0, 10).join('\n');
        urlCount.textContent = '10';
        return;
      }
      previewGrid.innerHTML = '';
      urls.forEach((url, index) => {
        const filename = extractFilenameFromUrl(url);
        const previewCol = document.createElement('div');
        previewCol.className = 'col-md-6 col-lg-4 mb-3';
        previewCol.innerHTML = `
          <div class="card">
            <img src="${url}" class="challenge-image card-img-top" alt="Preview ${index + 1}">
            <div class="card-body">
              <p class="card-text text-muted small">${filename || 'Invalid URL'}</p>
            </div>
          </div>
        `;
        previewGrid.appendChild(previewCol);
      });
    });

    // Create challenge handler
    document.getElementById('createForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!adminKey) {
        alert('Please set your admin key first');
        adminKeyModal.show();
        return;
      }
      const dateET = document.getElementById('date').value;
      const imageUrlsText = document.getElementById('imageUrls').value.trim();
      const appendImages = document.getElementById('appendImages').checked;
      if (!dateET || !imageUrlsText) {
        alert('Please fill all required fields');
        return;
      }
      const imageUrls = parseImageUrls(imageUrlsText);
      if (imageUrls.length === 0) {
        alert('No valid Wikimedia URLs found');
        return;
      }
      if (imageUrls.length > 10) {
        alert('Maximum 10 images allowed');
        return;
      }
      
      // Convert ET to UTC for API
      const dateUTC = convertToUTC(dateET).toISOString();
      
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';
      try {
        const response = await fetch(`/admin/daily-challenge/create?adminKey=${adminKey}&append=${appendImages}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ date: dateUTC, imageUrls })
        });
        const data = await response.json();
        if (response.ok) {
          alert(`Success: ${data.message}. Added ${data.challenge.imageCount} images.`);
          document.getElementById('createForm').reset();
          document.getElementById('previewGrid').innerHTML = '';
          document.getElementById('urlCount').textContent = '0';
          loadChallenges();
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        alert(`Request failed: ${error.message}`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    });

    // Open edit challenge modal
    function openEditModal(challengeId) {
      const challenge = allChallenges.find(ch => ch._id === challengeId);
      if (!challenge) return;
      
      currentEditingChallenge = challenge;
      
      // Convert UTC to ET for display
      const dateET = convertToET(challenge.date);
      document.getElementById('editChallengeId').value = challengeId;
      document.getElementById('editChallengeDate').value = formatDateForInput(dateET);
      
      // Display existing images
      const imagesContainer = document.getElementById('editImagesContainer');
      imagesContainer.innerHTML = '';
      
      challenge.images.forEach((image, index) => {
        const imageCol = document.createElement('div');
        imageCol.className = 'col-md-6 col-lg-4';
        imageCol.innerHTML = `
          <div class="card image-item" data-index="${index}">
            <div class="badge-overlay">${image.year}</div>
            <img src="${image.url}" class="challenge-image card-img-top" alt="${image.title || 'Challenge image'}">
            <div class="image-controls">
              <button type="button" class="btn btn-sm btn-danger delete-image-btn" data-index="${index}">
                <i class="bi bi-trash"></i> Remove
              </button>
            </div>
            <div class="card-body">
              <p class="card-text text-muted small">${image.title || extractFilenameFromUrl(image.url) || 'Image'}</p>
            </div>
          </div>
        `;
        imagesContainer.appendChild(imageCol);
      });
      
      // Add event listeners to delete buttons
      document.querySelectorAll('.delete-image-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          if (confirm(`Remove image ${index + 1}?`)) {
            this.closest('.col-md-6').remove();
          }
        });
      });
      
      editChallengeModal.show();
    }

    // Save edit challenge changes
    document.getElementById('saveEditBtn').addEventListener('click', async function() {
      if (!currentEditingChallenge) return;
      
      const challengeId = document.getElementById('editChallengeId').value;
      const dateET = document.getElementById('editChallengeDate').value;
      const newImagesText = document.getElementById('editNewImages').value.trim();
      
      // Convert ET to UTC for API
      const dateUTC = convertToUTC(dateET).toISOString();
      
      // Get indices of images to keep (those not deleted)
      const keepIndices = Array.from(document.querySelectorAll('.image-item'))
        .map(el => parseInt(el.getAttribute('data-index')));
      
      // Parse new image URLs
      const newImageUrls = parseImageUrls(newImagesText);
      
      this.disabled = true;
      this.textContent = 'Saving...';
      
      try {
        const response = await fetch(`/admin/daily-challenge/${challengeId}/edit?adminKey=${adminKey}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            date: dateUTC,
            keepImages: keepIndices,
            newImageUrls
          })
        });
        
        const data = await response.json();
        if (response.ok) {
          alert('Challenge updated successfully');
          editChallengeModal.hide();
          loadChallenges();
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        alert(`Request failed: ${error.message}`);
      } finally {
        this.disabled = false;
        this.textContent = 'Save Changes';
      }
    });

    // Render calendar view
    function renderCalendar(displayDate, challengeDates) {
      const calendarContainer = document.getElementById('calendarContainer');
      calendarContainer.innerHTML = '';

      // Header with navigation
      const headerDiv = document.createElement('div');
      headerDiv.className = 'd-flex justify-content-between align-items-center mb-3';
      const prevBtn = document.createElement('button');
      prevBtn.className = 'btn btn-outline-secondary';
      prevBtn.textContent = '<';
      const nextBtn = document.createElement('button');
      nextBtn.className = 'btn btn-outline-secondary';
      nextBtn.textContent = '>';
      const monthLabel = document.createElement('h4');
      monthLabel.className = 'mb-0';
      const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      monthLabel.textContent = monthNames[displayDate.getMonth()] + ' ' + displayDate.getFullYear();
      headerDiv.appendChild(prevBtn);
      headerDiv.appendChild(monthLabel);
      headerDiv.appendChild(nextBtn);
      calendarContainer.appendChild(headerDiv);

      // Create calendar table
      const table = document.createElement('table');
      table.className = 'table table-sm text-center';
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayNames.forEach(day => {
        const th = document.createElement('th');
        th.textContent = day;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      const firstDay = new Date(displayDate.getFullYear(), displayDate.getMonth(), 1);
      const startingDay = firstDay.getDay();
      const daysInMonth = new Date(displayDate.getFullYear(), displayDate.getMonth() + 1, 0).getDate();
      let dateCounter = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          if (i === 0 && j < startingDay) {
            cell.textContent = '';
          } else if (dateCounter > daysInMonth) {
            cell.textContent = '';
          } else {
            cell.textContent = dateCounter;
            const cellDate = new Date(displayDate.getFullYear(), displayDate.getMonth(), dateCounter);
            const cellDateStr = cellDate.toISOString().split('T')[0];
            if (challengeDates.includes(cellDateStr)) {
              cell.style.backgroundColor = '#6C2DC7';
              cell.style.color = '#fff';
            }
            cell.style.cursor = 'pointer';
            cell.addEventListener('click', () => {
              filterChallengesByDate(cellDateStr);
            });
            dateCounter++;
          }
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      }
      table.appendChild(tbody);
      calendarContainer.appendChild(table);

      // Navigation events
      prevBtn.addEventListener('click', () => {
        currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
        renderCalendar(currentDisplayDate, challengeDates);
      });
      nextBtn.addEventListener('click', () => {
        currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
        renderCalendar(currentDisplayDate, challengeDates);
      });
    }

    function renderCalendarFromChallenges(challenges) {
      const challengeDates = challenges.map(ch => new Date(ch.date).toISOString().split('T')[0]);
      const uniqueDates = [...new Set(challengeDates)];
      renderCalendar(currentDisplayDate, uniqueDates);
    }

    // Render challenges list
    function renderChallengesList(challenges) {
      const challengesListEl = document.getElementById('challengesList');
      if (challenges.length === 0) {
        challengesListEl.innerHTML = `
          <div class="col-12">
            <div class="alert alert-info">No challenges created yet</div>
          </div>
        `;
        return;
      }
      
      challenges.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      const html = challenges.map(challenge => {
        const dateET = convertToET(challenge.date);
        const formattedDate = dateET.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          timeZone: 'America/New_York'
        }) + ' ET';
        
        const image = challenge.images[0];
        return `
          <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
              <img src="${image.url}" class="challenge-image card-img-top" alt="${image.title || 'Challenge image'}">
              <div class="card-body">
                <h5 class="card-title">${formattedDate}</h5>
                <p class="card-text text-muted">${image.title || extractFilenameFromUrl(image.url) || 'Image'}</p>
                <p class="card-text">
                  <small class="text-muted">Year: ${image.year}</small><br>
                  <small class="text-muted">Images: ${challenge.images.length}</small><br>
                  <small class="text-muted">Completions: ${challenge.stats ? challenge.stats.completions : 0}</small>
                </p>
              </div>
              <div class="card-footer d-flex justify-content-between">
                <span class="badge bg-${challenge.active ? 'success' : 'secondary'}">
                  ${challenge.active ? 'Active' : 'Inactive'}
                </span>
                <div>
                  <button class="btn btn-sm btn-primary edit-btn me-1" data-id="${challenge._id}">
                    Edit
                  </button>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${challenge._id}">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      challengesListEl.innerHTML = html;
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', deleteChallenge);
      });
      
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          openEditModal(id);
        });
      });
    }

    function filterChallengesByDate(dateStr) {
      const filtered = allChallenges.filter(ch => {
        const chDateStr = new Date(ch.date).toISOString().split('T')[0];
        return chDateStr === dateStr;
      });
      renderChallengesList(filtered);
    }

    // Load existing challenges and update calendar
    async function loadChallenges() {
      if (!adminKey) {
        document.getElementById('challengesList').innerHTML = `
          <div class="col-12">
            <div class="alert alert-warning">Please set your admin key to view challenges</div>
          </div>
        `;
        return;
      }
      document.getElementById('challengesList').innerHTML = `
        <div class="col-12 text-center">
          <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `;
      try {
        const response = await fetch(`/admin/daily-challenges?adminKey=${adminKey}`);
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to load challenges');
        }
        const challenges = await response.json();
        allChallenges = challenges;
        renderCalendarFromChallenges(challenges);
        renderChallengesList(challenges);
      } catch (error) {
        document.getElementById('challengesList').innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">${error.message || 'Failed to load challenges'}</div>
          </div>
        `;
      }
    }

    async function deleteChallenge() {
      if (!confirm('Are you sure you want to delete this challenge?')) {
        return;
      }
      const id = this.getAttribute('data-id');
      try {
        const response = await fetch(`/admin/daily-challenge/${id}?adminKey=${adminKey}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        if (response.ok) {
          alert('Challenge deleted successfully');
          loadChallenges();
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        alert(`Request failed: ${error.message}`);
      }
    }

    // Set initial date/time to current ET time
    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      const etNow = convertToET(now);
      document.getElementById('date').value = formatDateForInput(etNow);
      
      loadChallenges();
      
      if (!adminKey) {
        setTimeout(() => {
          adminKeyModal.show();
        }, 500);
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', loadChallenges);
  </script>
</body>
</html>