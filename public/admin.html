<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Year Guessing Game - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
  <style>
    :root {
      --primary: #7B38D8;
      --primary-hover: #6429C8;
      --dark-bg: #121212;
      --card-bg: #1E1E1E;
      --card-header: #2D2D2D;
      --input-bg: #2A2A2A;
      --border-color: #444444;
      --bs-heading-color: #FFFFFF;
      --bs-card-color: #FFFFFF;
      --text-primary: #FFFFFF;
      --text-secondary: #CCCCCC;
      --text-muted: #AAAAAA;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
    }
    body {
      background-color: var(--dark-bg);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
    }
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
      transition: box-shadow 0.2s;
    }
    .card:hover {
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }
    .card-header {
      background-color: var(--card-header);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 20px;
      font-weight: 600;
      border-radius: 7px 7px 0 0;
    }
    .form-control, .form-select {
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 6px;
      padding: 10px 15px;
    }
    .form-control::placeholder {
      color: var(--text-muted);
    }
    .form-check-label {
      color: white;
    }
    .form-check-input {
      background-color: var(--input-bg);
      border-color: var(--border-color);
    }
    .form-check-input:checked {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--input-bg);
      color: var(--text-primary);
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(123, 56, 216, 0.25);
    }
    .form-label {
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 8px;
    }
    .form-text {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 4px;
    }
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 6px;
    }
    .btn-primary:hover, .btn-primary:focus {
      background-color: var(--primary-hover);
      border-color: var(--primary-hover);
    }
    .btn-outline-secondary {
      color: var(--text-primary);
      border-color: var(--border-color);
      background-color: transparent;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 6px;
    }
    .btn-outline-secondary:hover {
      background-color: var(--border-color);
      color: var(--text-primary);
    }
    .btn-danger {
      background-color: var(--danger);
      border-color: var(--danger);
    }
    .btn-success {
      background-color: var(--success);
      border-color: var(--success);
    }
    .table {
      color: var(--text-primary);
      border-color: var(--border-color);
      background-color: var(--card-bg);
    }
    .table thead {
      background-color: var(--card-header);
    }
    .table td, .table th {
      border-color: var(--border-color);
      vertical-align: middle;
    }
    .text-muted {
      color: var(--text-muted) !important;
    }
    .badge {
      padding: 6px 10px;
      font-weight: 500;
      border-radius: 4px;
    }
    .modal-content {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 8px;
    }
    .modal-header {
      border-bottom: 1px solid var(--border-color);
      background-color: var(--card-header);
    }
    .modal-footer {
      border-top: 1px solid var(--border-color);
    }
    .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
    }
    .challenge-image {
      height: 180px;
      width: 100%;
      object-fit: cover;
      border-radius: 6px 6px 0 0;
    }
    /* Drag handle styling */
    .drag-handle {
      cursor: move;
    }
    /* Calendar specific styles */
    #calendarContainer table {
      color: var(--text-primary);
      background-color: var(--card-bg);
    }
    #calendarContainer th {
      background-color: var(--card-header);
      color: var(--text-primary);
      padding: 10px;
      text-align: center;
    }
    #calendarContainer td {
      border-color: var(--border-color);
      background-color: var(--card-bg);
    }
    .calendar-day {
      height: 40px;
      width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 2px auto;
      border-radius: 50%;
      color: var(--text-primary);
    }
    .has-challenge {
      background-color: var(--primary);
      color: white;
      cursor: pointer;
    }
    .timezone-indicator {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
      <h1 class="mb-3 mb-md-0">Year Guessing Game - Admin</h1>
      <div>
        <span class="timezone-indicator me-3">All times in Central Time (CT)</span>
        <button class="btn btn-outline-secondary" id="setKeyBtn">
          <i class="bi bi-key-fill me-1"></i> Set Admin Key
        </button>
      </div>
    </div>

    <!-- Create Challenge Card -->
    <div class="card">
      <div class="card-header">
        <h3 class="m-0">Create Daily Challenge</h3>
      </div>
      <div class="card-body">
        <form id="createForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="date" class="form-label">Challenge Date (CT)</label>
              <input type="date" class="form-control" id="date" required />
              <div class="form-text">Set which day this challenge should be available</div>
            </div>
          </div>

          <!-- Wikimedia Images Section -->
          <div class="mb-4">
            <label class="form-label">Wikimedia Images</label>
            <textarea class="form-control" id="imageUrls" rows="3" 
                      placeholder="Enter Wikimedia URLs (one per line or comma-separated)"></textarea>
            <div class="form-text">Add up to 10 Wikimedia URLs</div>
            <button type="button" class="btn btn-outline-secondary mt-2" id="addWikimediaBtn">
              <i class="bi bi-plus-circle me-1"></i> Add Wikimedia Images
            </button>
          </div>

          <!-- File Upload Section -->
          <div class="mb-4">
            <label class="form-label">Upload Custom Images</label>
            <input type="file" class="form-control" id="imageUpload" multiple accept="image/*" />
            <div class="form-text">Upload images (max 5MB each, up to 5 images)</div>
          </div>

          <!-- Unified Challenge Images Container -->
          <div class="mb-4">
            <h5>Arrange Challenge Images</h5>
            <div id="challengeImagesContainer" class="row"></div>
          </div>

          <div class="form-check mb-4">
            <input class="form-check-input" type="checkbox" id="appendImages" />
            <label class="form-check-label" for="appendImages">
              Append to existing images (if date already has a challenge)
            </label>
          </div>

          <button type="submit" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Create Challenge
          </button>
        </form>
      </div>
    </div>

    <!-- Calendar Card -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="m-0">Challenge Calendar</h3>
      </div>
      <div class="card-body" id="calendarContainer">
        <!-- Calendar will be rendered here -->
      </div>
    </div>

    <!-- Existing Challenges Card -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="m-0">Existing Challenges</h3>
        <button id="refreshBtn" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </button>
      </div>
      <div class="card-body">
        <div id="challengesList" class="row">
          <!-- Challenges will be listed here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Key Modal -->
  <div class="modal fade" id="adminKeyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Set Admin Key</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="adminKey" class="form-label">Admin API Key</label>
            <input type="password" class="form-control" id="adminKey" placeholder="Enter your admin API key" />
            <div class="form-text">This should match the ADMIN_API_KEY in your server's environment variables.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveKeyBtn">Save Key</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Challenge Modal -->
  <div class="modal fade" id="editChallengeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Challenge</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editChallengeForm">
            <input type="hidden" id="editChallengeId">
            <div class="mb-3">
              <label for="editChallengeDate" class="form-label">Challenge Date (CT)</label>
              <input type="date" class="form-control" id="editChallengeDate" required />
            </div>

            <!-- Existing & New Images Container -->
            <div class="mb-3">
              <label class="form-label">Challenge Images</label>
              <div id="editImagesContainer" class="row">
                <!-- Existing (and newly added) images will be listed here -->
              </div>
            </div>

            <!-- Wikimedia URLs for new images -->
            <div class="mb-3">
              <label class="form-label">Add New Wikimedia Images</label>
              <textarea class="form-control" id="editNewImages" rows="3" 
                        placeholder="Add new Wikimedia URLs (one per line or comma-separated)"></textarea>
              <button type="button" class="btn btn-outline-secondary mt-2" id="addEditWikimediaBtn">
                <i class="bi bi-plus-circle me-1"></i> Add Wikimedia Images
              </button>
            </div>
            
            <!-- Upload New Images -->
            <div class="mb-3">
              <label class="form-label">Upload New Images</label>
              <input type="file" class="form-control" id="editImageUpload" multiple accept="image/*" />
              <div class="form-text">Upload images (max 5MB each, up to 5 images)</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Include SortableJS for drag-and-drop reordering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------------------------------------------------
    // Global variables and initialization
    // ---------------------------------------------------
    let adminKey = localStorage.getItem('adminKey') || '';
    let allChallenges = [];
    let currentDisplayDate = new Date();
    let currentEditingChallenge = null;
    // For new uploaded files in create mode
    let uploadFilesMap = {};
    let uploadFileCounter = 0;
    // For new uploaded files in edit mode
    let editUploadFilesMap = {};
    let editUploadFileCounter = 0;

    // Modal instances
    const adminKeyModal = new bootstrap.Modal(document.getElementById('adminKeyModal'));
    const editChallengeModal = new bootstrap.Modal(document.getElementById('editChallengeModal'));

    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      const ctNow = convertToCT(now);
      document.getElementById('date').value = formatDateForInput(ctNow);
      loadChallenges();
      if (!adminKey) {
        setTimeout(() => {
          adminKeyModal.show();
        }, 500);
      }
      setupEventListeners();
      // Initialize Sortable for create and edit containers
      new Sortable(document.getElementById('challengeImagesContainer'), {
        animation: 150,
        handle: '.drag-handle'
      });
    });

    function setupEventListeners() {
      document.getElementById('setKeyBtn').addEventListener('click', () => {
        document.getElementById('adminKey').value = adminKey;
        adminKeyModal.show();
      });
      document.getElementById('saveKeyBtn').addEventListener('click', () => {
        const newKey = document.getElementById('adminKey').value.trim();
        if (newKey) {
          adminKey = newKey;
          localStorage.setItem('adminKey', adminKey);
          adminKeyModal.hide();
          loadChallenges();
        }
      });
      document.getElementById('addWikimediaBtn').addEventListener('click', handleAddWikimedia);
      document.getElementById('imageUpload').addEventListener('change', handleFileSelection);
      document.getElementById('editImageUpload').addEventListener('change', handleEditFileSelection);
      document.getElementById('createForm').addEventListener('submit', handleCreateFormSubmit);
      document.getElementById('saveEditBtn').addEventListener('click', handleSaveEditClick);
      document.getElementById('refreshBtn').addEventListener('click', loadChallenges);
      // For edit modal Wikimedia URLs
      document.getElementById('addEditWikimediaBtn').addEventListener('click', handleAddEditWikimedia);
    }

    // ---------------------------------------------------
    // Date/Time utilities
    // ---------------------------------------------------
    function convertToCT(utcDate) {
      const date = new Date(utcDate);
      return new Date(date.toLocaleString('en-US', {timeZone: 'America/Chicago'}));
    }
    function convertToUTC(ctDateStr) {
  // If date string doesn't have time, add noon time to avoid date boundary issues
  if (ctDateStr.length === 10) {
    ctDateStr = `${ctDateStr}T12:00:00`;
  }
  
  // Just create a regular Date object from the string without timezone manipulations
  return new Date(ctDateStr);
}
    function formatDateForInput(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ---------------------------------------------------
    // Utility to create an image card for the unified container
    // ---------------------------------------------------
   // Updated createImageCard function to include revealedDescription field
function createImageCard(options) {
  // options: { type: 'wikimedia'|'upload', url, fileId (for uploads) }
  const { type, url, fileId } = options;
  const card = document.createElement('div');
  card.className = 'col-md-4 mb-3';
  card.dataset.type = type;
  if (type === 'wikimedia') {
    card.dataset.url = url;
  } else if (type === 'upload') {
    card.dataset.uploadId = fileId;
  }
  // For new cards in create mode, no "existing" flag is set.
  const currentYear = new Date().getFullYear();
  card.innerHTML = `
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="drag-handle"><i class="bi bi-arrows-move"></i></span>
        <button type="button" class="btn btn-sm btn-danger delete-image-btn">
          <i class="bi bi-trash"></i>
        </button>
      </div>
      <img src="${url}" class="challenge-image card-img-top" alt="Image" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22300%22%20height%3D%22180%22%20viewBox%3D%220%200%20300%20180%22%3E%3Crect%20fill%3D%22%23444%22%20width%3D%22300%22%20height%3D%22180%22%2F%3E%3Ctext%20fill%3D%22%23fff%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-size%3D%2212%22%20x%3D%22110%22%20y%3D%2290%22%3EImage%20Error%3C%2Ftext%3E%3C%2Fsvg%3E'">
      <div class="card-body">
        <div class="mb-2">
          <label class="form-label">Year</label>
          <input type="number" class="form-control image-year" value="${currentYear}" min="1800" max="2025">
        </div>
        <div class="mb-2">
          <label class="form-label">Description (Before Guess)</label>
          <textarea class="form-control image-description" rows="2"></textarea>
        </div>
        <div class="mb-2">
          <label class="form-label">Revealed Description (After Guess)</label>
          <textarea class="form-control image-revealed-description" rows="2"></textarea>
        </div>
      </div>
    </div>
  `;
  card.querySelector('.delete-image-btn').addEventListener('click', () => {
    card.remove();
  });
  return card;
}

    // ---------------------------------------------------
    // Wikimedia Images - Create Mode
    // ---------------------------------------------------
    function handleAddWikimedia() {
      const text = document.getElementById('imageUrls').value.trim();
      let urls = text.split(/\n/).map(line => line.trim()).filter(line => line);
      if (urls.length === 1) {
        urls = urls[0].split(',').map(url => url.trim()).filter(url => url);
      }
      // Filter to wikimedia URLs only
      urls = urls.filter(url => url.includes('wikimedia.org'));
      if (urls.length === 0) {
        alert('No valid Wikimedia URLs found.');
        return;
      }
      const container = document.getElementById('challengeImagesContainer');
      // Enforce a maximum total count (if needed, e.g., 10)
      if (container.children.length + urls.length > 10) {
        alert('Adding these images would exceed the maximum allowed (10).');
        return;
      }
      urls.forEach(url => {
        const card = createImageCard({ type: 'wikimedia', url });
        container.appendChild(card);
      });
      // Optionally clear the textarea
      document.getElementById('imageUrls').value = '';
    }

    // ---------------------------------------------------
    // File Upload handling - Create Mode
    // ---------------------------------------------------
    function handleFileSelection(e) {
      const files = Array.from(e.target.files);
      if (files.length > 5) {
        alert('Maximum 5 files allowed');
        this.value = '';
        return;
      }
      const oversized = files.filter(file => file.size > 5 * 1024 * 1024);
      if (oversized.length) {
        alert(`Files too large: ${oversized.map(f => f.name).join(', ')}`);
        this.value = '';
        return;
      }
      const container = document.getElementById('challengeImagesContainer');
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          // Assign a unique id for this file
          const fileId = 'upload_' + uploadFileCounter++;
          uploadFilesMap[fileId] = file;
          const card = createImageCard({ type: 'upload', url: e.target.result, fileId });
          container.appendChild(card);
        };
        reader.readAsDataURL(file);
      });
      this.value = ''; // Reset file input
    }

    // ---------------------------------------------------
    // Create Challenge Form submission
    // ---------------------------------------------------
    async function handleCreateFormSubmit(e) {
      e.preventDefault();
      if (!adminKey) {
        alert('Please set your admin key first');
        adminKeyModal.show();
        return;
      }
      const dateCT = document.getElementById('date').value;
      if (!dateCT) {
        alert('Please provide a date');
        return;
      }
      const appendImages = document.getElementById('appendImages').checked;
      const dateUTC = convertToUTC(dateCT).toISOString();
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Creating...';

      try {
        const formData = new FormData();
        formData.append('date', dateUTC);
        formData.append('append', appendImages);
        // Build an ordered list of images from the unified container
        const container = document.getElementById('challengeImagesContainer');
  const cards = container.querySelectorAll('.col-md-4');
  let uploadIndex = 0;
  let imagesOrder = [];
  cards.forEach(card => {
    const type = card.dataset.type;
    const year = card.querySelector('.image-year').value;
    const description = card.querySelector('.image-description').value;
    const revealedDescription = card.querySelector('.image-revealed-description').value;
    
    if (type === 'wikimedia') {
      imagesOrder.push({ 
        type, 
        url: card.dataset.url, 
        year: parseInt(year, 10), 
        description,
        revealedDescription
      });
    } else if (type === 'upload') {
      imagesOrder.push({ 
        type, 
        uploadIndex, 
        year: parseInt(year, 10), 
        description,
        revealedDescription
      });
      // Append file from our map
      formData.append(`uploadFiles_${uploadIndex}`, uploadFilesMap[card.dataset.uploadId]);
      uploadIndex++;
    }
  });
  formData.append('imagesOrder', JSON.stringify(imagesOrder));
  
        const response = await fetch(`/admin/daily-challenge/create?adminKey=${adminKey}`, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (response.ok) {
          alert(`Success: ${data.message}. Added ${data.challenge.imageCount} images.`);
          document.getElementById('createForm').reset();
          document.getElementById('challengeImagesContainer').innerHTML = '';
          uploadFilesMap = {};
          loadChallenges();
          const now = new Date();
          const ctNow = convertToCT(now);
          document.getElementById('date').value = formatDateForInput(ctNow);
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        alert(`Request failed: ${error.message}`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }

    // ---------------------------------------------------
    // Edit Mode: Adding new Wikimedia images
    // ---------------------------------------------------
    function handleAddEditWikimedia() {
      const text = document.getElementById('editNewImages').value.trim();
      let urls = text.split(/\n/).map(line => line.trim()).filter(line => line);
      if (urls.length === 1) {
        urls = urls[0].split(',').map(url => url.trim()).filter(url => url);
      }
      urls = urls.filter(url => url.includes('wikimedia.org'));
      if (urls.length === 0) {
        alert('No valid Wikimedia URLs found.');
        return;
      }
      const container = document.getElementById('editImagesContainer');
      // (You may enforce a max count here as needed)
      urls.forEach(url => {
        const card = createImageCard({ type: 'wikimedia', url });
        // Mark as new (not existing)
        card.dataset.existing = 'false';
        container.appendChild(card);
      });
      document.getElementById('editNewImages').value = '';
    }

    // ---------------------------------------------------
    // File Upload handling - Edit Mode
    // ---------------------------------------------------
    function handleEditFileSelection(e) {
      const files = Array.from(e.target.files);
      if (files.length > 5) {
        alert('Maximum 5 files allowed');
        this.value = '';
        return;
      }
      const oversized = files.filter(file => file.size > 5 * 1024 * 1024);
      if (oversized.length) {
        alert(`Files too large: ${oversized.map(f => f.name).join(', ')}`);
        this.value = '';
        return;
      }
      const container = document.getElementById('editImagesContainer');
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileId = 'editUpload_' + editUploadFileCounter++;
          editUploadFilesMap[fileId] = file;
          const card = createImageCard({ type: 'upload', url: e.target.result, fileId });
          card.dataset.existing = 'false';
          container.appendChild(card);
        };
        reader.readAsDataURL(file);
      });
      this.value = '';
    }

    // ---------------------------------------------------
    // Open Edit Challenge Modal
    // ---------------------------------------------------
    function openEditModal(challengeId) {
  const challenge = allChallenges.find(ch => ch._id === challengeId);
  if (!challenge) return;
  currentEditingChallenge = challenge;
  const dateCT = convertToCT(challenge.date);
  document.getElementById('editChallengeId').value = challengeId;
  document.getElementById('editChallengeDate').value = formatDateForInput(dateCT);
  const container = document.getElementById('editImagesContainer');
  container.innerHTML = '';
  // Populate existing images
  challenge.images.forEach((image, index) => {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-3 image-item';
    card.dataset.existing = 'true';
    card.dataset.originalIndex = index;
    card.innerHTML = `
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="drag-handle"><i class="bi bi-arrows-move"></i></span>
          <button type="button" class="btn btn-sm btn-danger delete-image-btn">
            <i class="bi bi-trash"></i>
          </button>
        </div>
        <img src="${image.url}" class="challenge-image card-img-top" alt="${image.title || 'Image'}" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22300%22%20height%3D%22180%22%20viewBox%3D%220%200%20300%20180%22%3E%3Crect%20fill%3D%22%23444%22%20width%3D%22300%22%20height%3D%22180%22%2F%3E%3Ctext%20fill%3D%22%23fff%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-size%3D%2212%22%20x%3D%22110%22%20y%3D%2290%22%3EImage%20Error%3C%2Ftext%3E%3C%2Fsvg%3E'">
        <div class="card-body">
          <p class="card-text text-muted small">${image.title || ''}</p>
          <div class="mb-2">
            <label class="form-label">Year</label>
            <input type="number" class="form-control form-control-sm image-year" value="${image.year}" min="1800" max="2025">
          </div>
          <div class="mb-2">
            <label class="form-label">Description (Before Guess)</label>
            <textarea class="form-control form-control-sm image-description" rows="2">${image.description || ''}</textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Revealed Description (After Guess)</label>
            <textarea class="form-control form-control-sm image-revealed-description" rows="2">${image.revealedDescription || ''}</textarea>
          </div>
        </div>
      </div>
    `;
    card.querySelector('.delete-image-btn').addEventListener('click', () => {
      card.remove();
    });
    container.appendChild(card);
  });
  // Clear new image inputs
  document.getElementById('editNewImages').value = '';
  document.getElementById('editImageUpload').value = '';
  editUploadFilesMap = {};
  // Initialize Sortable for edit container
  new Sortable(container, {
    animation: 150,
    handle: '.drag-handle'
  });
  editChallengeModal.show();
}

    // ---------------------------------------------------
    // Save Edit Challenge Handler
    // ---------------------------------------------------
    async function handleSaveEditClick() {
  if (!adminKey) {
    alert('Please set your admin key first');
    adminKeyModal.show();
    return;
  }
  const challengeId = document.getElementById('editChallengeId').value;
  const dateCT = document.getElementById('editChallengeDate').value;
  if (!challengeId || !dateCT) {
    alert('Missing required information');
    return;
  }
  const dateUTC = convertToUTC(dateCT).toISOString();
  const container = document.getElementById('editImagesContainer');
  const cards = container.querySelectorAll('.col-md-4');
  let uploadIndex = 0;
  let imagesOrder = [];
  
  // Create FormData object 
  const formData = new FormData();
  formData.append('date', dateUTC);
  
  cards.forEach(card => {
    const year = card.querySelector('.image-year').value;
    const description = card.querySelector('.image-description').value;
    const revealedDescription = card.querySelector('.image-revealed-description').value;
    
    if (card.dataset.existing === 'true') {
      imagesOrder.push({
        type: 'existing',
        originalIndex: card.dataset.originalIndex,
        year: parseInt(year, 10),
        description,
        revealedDescription
      });
    } else {
      const type = card.dataset.type;
      if (type === 'wikimedia') {
        imagesOrder.push({ 
          type: 'wikimedia', 
          url: card.dataset.url, 
          year: parseInt(year, 10), 
          description,
          revealedDescription
        });
      } else if (type === 'upload') {
        imagesOrder.push({ 
          type: 'upload', 
          uploadIndex, 
          year: parseInt(year, 10), 
          description,
          revealedDescription
        });
        
        // Directly append file to FormData (fix for missing files)
        if (editUploadFilesMap[card.dataset.uploadId]) {
          formData.append(`uploadedFiles`, editUploadFilesMap[card.dataset.uploadId]);
          uploadIndex++;
        }
      }
    }
  });
  
  // Add imagesOrder to FormData
  formData.append('imagesOrder', JSON.stringify(imagesOrder));
  
  const saveBtn = document.getElementById('saveEditBtn');
  const originalText = saveBtn.innerHTML;
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Saving...';
  
  try {
    const response = await fetch(`/admin/daily-challenge/${challengeId}/edit?adminKey=${adminKey}`, {
      method: 'PUT',
      body: formData
    });
    
    const data = await response.json();
    if (response.ok) {
      alert(`Success: ${data.message}`);
      editChallengeModal.hide();
      loadChallenges();
      editUploadFilesMap = {};
    } else {
      alert(`Error: ${data.error}`);
    }
  } catch (error) {
    alert(`Request failed: ${error.message}`);
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalText;
  }
}



      // This function is here in case you need to modify how files are appended
      // For now, it simply calls formData.append(key, file) within the submission handler.


    // ---------------------------------------------------
    // API interaction functions (loadChallenges, deleteChallenge, calendar rendering, etc.)
    // (Keep your existing implementations for these functions.)
    // ---------------------------------------------------
    async function loadChallenges() {
      if (!adminKey) {
        console.log('Admin key not set, skipping challenge load');
        return;
      }
      try {
        const refreshBtn = document.getElementById('refreshBtn');
        const originalText = refreshBtn.textContent;
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Loading...';
        const response = await fetch(`/admin/daily-challenges?adminKey=${adminKey}`);
        if (!response.ok) {
          if (response.status === 401) {
            alert('Unauthorized. Please check your admin key.');
            adminKeyModal.show();
          } else {
            alert(`Error fetching challenges: ${response.statusText}`);
          }
          return;
        }
        const challenges = await response.json();
        allChallenges = challenges;
        renderChallengesList(challenges);
        const now = new Date();
        renderCalendar(now.getFullYear(), now.getMonth(), challenges);
      } catch (error) {
        alert(`Failed to load challenges: ${error.message}`);
      } finally {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i> Refresh';
      }
    }

    function deleteChallenge() {
      if (!adminKey) {
        alert('Please set your admin key first');
        adminKeyModal.show();
        return;
      }
      const challengeId = this.getAttribute('data-id');
      if (!confirm('Are you sure you want to delete this challenge? This action cannot be undone.')) {
        return;
      }
      fetch(`/admin/daily-challenge/${challengeId}?adminKey=${adminKey}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert(`Error: ${data.error}`);
          } else {
            alert('Challenge deleted successfully');
            loadChallenges();
          }
        })
        .catch(error => {
          alert(`Request failed: ${error.message}`);
        });
    }

    function renderChallengesList(challenges) {
      const challengesListEl = document.getElementById('challengesList');
      if (challenges.length === 0) {
        challengesListEl.innerHTML = `<div class="col-12"><div class="alert alert-info">No challenges created yet</div></div>`;
        return;
      }
      challenges.sort((a, b) => new Date(b.date) - new Date(a.date));
      const html = challenges.map(challenge => {
        const dateCT = convertToCT(challenge.date);
        const formattedDate = dateCT.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          timeZone: 'America/Chicago'
        }) + ' CT';
        const image = challenge.images[0];
        return `
          <div class="col-md-4 col-lg-3 mb-4">
            <div class="card h-100">
              <div class="card-header p-2">
                <h6 class="m-0 text-center">${formattedDate}</h6>
              </div>
              <img src="${image.url}" class="challenge-image card-img-top" alt="${image.title || 'Challenge image'}" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22300%22%20height%3D%22180%22%20viewBox%3D%220%200%20300%20180%22%3E%3Crect%20fill%3D%22%23444%22%20width%3D%22300%22%20height%3D%22180%22%2F%3E%3Ctext%20fill%3D%22%23fff%22%20font-family%3D%22Arial%2C%20sans-serif%22%20font-size%3D%2212%22%20x%3D%22110%22%20y%3D%2290%22%3EImage%20Error%3C%2Ftext%3E%3C%2Fsvg%3E'" style="height: 120px;">
              <div class="card-footer d-flex justify-content-between align-items-center p-2">
                  <span class="text-muted">Images: ${challenge.images.length}</span>
                ${!challenge.active ? `<span class="badge bg-secondary">Inactive</span>` : ''}
                <div>
                  <button class="btn btn-sm btn-primary edit-btn" data-id="${challenge._id}">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${challenge._id}">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      challengesListEl.innerHTML = html;
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', deleteChallenge);
      });
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          openEditModal(id);
        });
      });
    }

    function renderCalendar(year, month, challenges) {
      const calendarContainer = document.getElementById('calendarContainer');
      const firstDay = new Date(year, month, 1);
      const startDay = firstDay.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const calendarControls = document.createElement('div');
      calendarControls.className = 'd-flex justify-content-between mb-3 align-items-center';
      calendarControls.innerHTML = `
        <button class="btn btn-outline-secondary" id="prevMonth">
          <i class="bi bi-chevron-left"></i> Prev
        </button>
        <h5 class="mb-0">${monthNames[month]} ${year}</h5>
        <button class="btn btn-outline-secondary" id="nextMonth">
          Next <i class="bi bi-chevron-right"></i>
        </button>
      `;
      const calendarTable = document.createElement('table');
      calendarTable.className = 'table table-bordered text-center';
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>`;
      calendarTable.appendChild(thead);
      const tbody = document.createElement('tbody');
      let date = 1;
      for (let i = 0; i < 6; i++) {
        if (date > daysInMonth) break;
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          if (i === 0 && j < startDay) {
            cell.innerHTML = '';
          } else if (date > daysInMonth) {
            cell.innerHTML = '';
          } else {
            const cellDate = new Date(year, month, date);
            const dateStr = cellDate.toISOString().split('T')[0];
            const hasChallenge = challenges.some(challenge => {
              const challengeDate = convertToCT(challenge.date);
              return challengeDate.toISOString().split('T')[0] === dateStr;
            });
            cell.innerHTML = `<div class="calendar-day ${hasChallenge ? 'has-challenge' : ''}">${date}</div>`;
            if (hasChallenge) {
              cell.style.cursor = 'pointer';
              cell.addEventListener('click', () => {
                const challenge = challenges.find(ch => {
                  const challengeDate = convertToCT(ch.date);
                  return challengeDate.toISOString().split('T')[0] === dateStr;
                });
                if (challenge) openEditModal(challenge._id);
              });
            }
            date++;
          }
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      }
      calendarTable.appendChild(tbody);
      calendarContainer.innerHTML = '';
      calendarContainer.appendChild(calendarControls);
      calendarContainer.appendChild(calendarTable);
      document.getElementById('prevMonth').addEventListener('click', () => {
        let newMonth = month - 1, newYear = year;
        if (newMonth < 0) { newMonth = 11; newYear--; }
        currentDisplayDate = new Date(newYear, newMonth, 1);
        renderCalendar(newYear, newMonth, challenges);
      });
      document.getElementById('nextMonth').addEventListener('click', () => {
        let newMonth = month + 1, newYear = year;
        if (newMonth > 11) { newMonth = 0; newYear++; }
        currentDisplayDate = new Date(newYear, newMonth, 1);
        renderCalendar(newYear, newMonth, challenges);
      });
    }
  </script>
</body>
</html>
